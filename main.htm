<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>华为固件扫描 - HwOCheck v3.0</title>
    <link href="lib/bootstrap.min.css" type="text/css" rel="stylesheet" />
    <link href="lib/skin/layer.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="lib/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="lib/layer.js"></script>
<style>
body {background-color: #f5f5f5; min-width:830px; font-family:"微软雅黑", "Microsoft Yahei", sans-serif}
option[value="-"] {color:#aaa;}
.form-group,select,input,label {float:left;}
input {width:85px !important; text-align:center;}
#queryBtn {margin-left: 5px !important;}
#model {width:150px;}
#querynum, #mode {width:90px;}
#toolbar .form-group * {margin:0 3px;}
#toolbar {margin-top: 10px; margin-left: 5px;}
tbody td {font-size:12px;}
.progress {height: 34px; width: 200px; float: right; margin-right: 10px; margin-bottom: 0; background-color: #ffffff;}
td:nth-child(1) {min-width:80px;}
td:nth-child(2) {min-width:180px;}
td:nth-child(3) {min-width:60px;}
td:nth-child(4) {min-width:90px;}
td:nth-child(5) {min-width:250px;}
td:nth-child(7) {min-width:70px;}
#result {width: 98%; margin: 0 auto; background-color: #ffffff; border-radius: 10px; overflow-y: auto;}
.progress-info {
    position: absolute;
    height: 34px;
    line-height: 34px;
    text-align: center;
    width: 200px;
    text-shadow: 0 0 5px #fff;
    font-size: 12px;
}
</style>
</head>
<body>
    <div id="toolbar" style="overflow: auto">
        <div class="form-group">
            <select id="model" class="form-control">
                <option value="">型号</option>
                <option value="G1018|g223">CHM-UL00</option>
                <option value="G1022|g223">CHM-TL00H</option>
                <option value="G1021|g223">CHM-TL00</option>
                <option value="G962|g77">EVA-AL19</option>
                <option value="G1079|g104">EVA-L09/L19</option>
                <!--<option value="custom">自定义</option>-->
            </select>
            <input type="text" class="form-control" id="startVersion" placeholder="起始版本">
            <input type="number" class="form-control" id="querynum" min="1" max="100000" step="10" placeholder="查询量">
            <select id="mode" class="form-control">
                <option value="">模式</option>
                <option value="1" selected>模式Ⅰ</option>
                <option value="2">模式Ⅱ</option>
            </select>
            <button id="queryBtn" class="btn btn-success">查询可用版本</button>
        </div>
        <div style="font-size:12px; color:#aaa; float:left; margin-top:8px; margin-left:15px;"><a href="https://twitter.com/dfc643" style="color:#aaa;">@sRetia</a></div>
        <div class="progress">
            <div class="progress-info">查询版本 / 最终版本</div>
            <div class="progress-bar progress-bar-striped active" role="progressbar" style="width: 0%"></div>
        </div>
    </div>
    <div id="result">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <td>编号</td>
                    <td>版本号</td>
                    <td>增量包</td>
                    <td>文件大小</td>
                    <td>校验码</td>
                    <td>更新内容</td>
                    <td>下载</td>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script type="text/javascript">
        function doCheck() {
            if($("#model").val() == "") {
                layer.tips('请先选择手机型号', '#model', {tips:3});
                return false;
            }
            else if($("#startVersion").val().length < 1) {
                layer.tips('请输入需要查询的起始版本', '#startVersion', {tips:3});
                return false;
            }
            else if($("#querynum").val().length < 1) {
                layer.tips('请输入想要查询的数量，最少 1 个，最多 10 万个', '#querynum', {tips:3});
                return false;
            }
            else if($("#mode").val() == "") {
                layer.tips('请选择查询模式，不知道请选模式Ⅰ，如果查询不到可以更换一个模式试试', '#mode', {tips:3});
                return false;
            }
            return true;
        }
    
        $("#queryBtn").click(function() {
            $(".progress .progress-bar").css("width", "0%");    // reset progress bar
            $("#result table tbody tr").remove(); //reset result
            
            if(!doCheck()) return; // If has something no fill go fail
            
            var endValue = $("#startVersion").val()*1+$("#querynum").val()*1-1; // computing end version num
            window.progress = 1;   // set global for progress bar
            window.endprogress = $("#querynum").val()*1;    // set global for progress
            
            for(var v=$("#startVersion").val(); v<=endValue; v++) {
                $.ajax({
                    url: "/proxy.php",
                    data: {
                        m: $("#model").val(),
                        v: v,
                        c: $("#mode").val(),
                        l: "2052",  // Chinese Only
                    },
                    success: function(ret) {
                        var data = JSON.parse(ret);
                        if(typeof(data.error) === 'undefined') {
                            var renderFormat = $(' \
                                <tr> \
                                    <td>' + data.id + '</td> \
                                    <td>' + data.version + '</td> \
                                    <td>' + (data.isOta ? "√" : "×") + '</td> \
                                    <td>' + data.dlSize + '</td> \
                                    <td>' + data.dlMd5 + '</td> \
                                    <td><a href="javascript:layer.alert(\'' + data.changlog + '\', {icon:1,skin:\'layer-ext-moon\'})">查看详情</a></td> \
                                    <td><a href="javascript:layer.prompt({formType: 2,value: \'' + data.dlLink + '\',title: \'下载地址\',btn: []})">获取</a></td> \
                                </tr> \
                            ');
                            $("#result table tbody").append(renderFormat);
                            $(".progress .progress-bar").css("width", (window.progress/window.endprogress)*100 + "%");
                        } else {
                            $(".progress .progress-bar").css("width", (window.progress/window.endprogress)*100 + "%");
                        }
                        $(".progress-info").text($("#startVersion").val()*1+window.progress + " / " + (endValue*1+1));
                        if((window.progress/window.endprogress) == 1) {
                            layer.alert('全部查询任务均已完成');
                        }
                        window.progress++;
                    }
                });
            }
        });
        $(window).on('load', function() {
            $("#result").css("height", $(window).height()-$("#toolbar").height()-20);
            
            layer.alert('本软件为开源软件，供花粉实验使用<br/>请勿放在中文路径或桌面将无法正常使用！<br/><br/>源代码下载：<a href="https://github.com/dfc643/huawei-firmware-scanner/tree/v3">@Github</a><br/>欢迎修改完善源代码并再发布', {
                icon: 0,
                title: '使用提示'
            })
        });
        $(window).resize(function() {
            $("#result").css("height", $(window).height()-$("#toolbar").height()-20);
        });
    </script>
</body>
</html>